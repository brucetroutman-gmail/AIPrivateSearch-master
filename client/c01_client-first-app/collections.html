<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Collections - AISearch-n-Score</title>
  <link rel="stylesheet" href="default.css">
  <link rel="stylesheet" href="shared/styles.css">
  <script src="csrf.js"></script>
  <script type="module" src="shared/common.js"></script>
  <style>
    .collections-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }
    
    .collections-section {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px var(--shadow);
    }
    
    .collections-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .collections-title {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--text-color);
    }
    
    .collections-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .collection-card {
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 1rem;
      background: var(--bg-color);
    }
    
    .collection-name {
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }
    
    .collection-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .btn {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s;
    }
    
    .btn-primary { background: #3498db; color: white; }
    .btn:hover { opacity: 0.8; }
    
    [data-theme="dark"] h1 {
      color: #87ceeb;
    }
    
    .message-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .message-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    [data-theme="dark"] .message-success {
      background: #1e4d3a;
      color: #28a745;
      border: 1px solid #28a745;
    }
    
    [data-theme="dark"] .message-error {
      background: #4d1e1e;
      color: #dc3545;
      border: 1px solid #dc3545;
    }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>

  <div class="page-content">
    <main class="collections-container">
      <h1>Manage Collections</h1>
      <p>Convert documents and manage embeddings for local document collections.</p>
      
      <div class="collections-section">
        <div class="collections-header">
          <div class="collections-title">Create New Collection</div>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <input type="text" id="newCollectionName" placeholder="Enter collection name" style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-color);">
          <button class="btn btn-primary" onclick="createNewCollection()">Create Collection</button>
        </div>
        <div id="createMessage" style="margin-top: 1rem; padding: 0.5rem; border-radius: 4px; display: none;"></div>
      </div>
      
      <div class="collections-section">
        <div class="collections-header">
          <div class="collections-title">Available Collections</div>
        </div>
        <div class="collections-grid" id="collectionsGrid">
          <div class="collection-card">
            <div class="collection-name">Loading collections...</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    let collections = [];
    
    async function loadCollections() {
      console.log('loadCollections called');
      try {
        const response = await fetch('http://localhost:3001/api/documents/collections?t=' + Date.now());
        const data = await response.json();
        collections = data.collections;
        console.log('Loaded collections:', collections);
        renderCollections();
      } catch (error) {
        console.error('Error loading collections:', error);
        showUserMessage('Failed to load collections: ' + error.message, 'error');
      }
    }
    
    async function renderCollections() {
      console.log('renderCollections called with:', collections);
      const container = document.getElementById('collectionsGrid');
      container.innerHTML = '';
      
      if (!collections || collections.length === 0) {
        container.innerHTML = '<div class="collection-card"><div class="collection-name">No collections found</div></div>';
        return;
      }
      
      for (const collection of collections) {
        console.log('Creating card for:', collection);
        const card = createCollectionCard(collection);
        container.appendChild(card);
      }
    }
    

    
    function createCollectionCard(collection) {
      console.log('Creating card for collection:', collection);
      const card = document.createElement('div');
      card.className = 'collection-card';
      
      card.innerHTML = `
        <div class="collection-name">${collection}</div>
        <div class="collection-actions">
          <button class="btn btn-primary" onclick="openCollectionEditor('${collection}')">Edit</button>
        </div>
      `;
      
      return card;
    }
    
    function openCollectionEditor(collection) {
      // Store collection name in sessionStorage as fallback for servers that strip URL params
      sessionStorage.setItem('currentCollection', collection);
      window.location.href = `./collections-editor.html?collection=${encodeURIComponent(collection)}`;
    }
    
    async function createNewCollection() {
      const nameInput = document.getElementById('newCollectionName');
      const collectionName = nameInput.value.trim();
      
      if (!collectionName) {
        showUserMessage('Please enter a collection name', 'error');
        return;
      }
      
      if (!/^[a-zA-Z0-9-_]+$/.test(collectionName)) {
        showUserMessage('Collection name can only contain letters, numbers, hyphens, and underscores', 'error');
        return;
      }
      
      showMessage(`Creating collection '${collectionName}'...`, 'info');
      
      try {
        const response = await window.csrfManager.fetch('http://localhost:3001/api/documents/collections/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: collectionName })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage(`✓ Collection '${collectionName}' created successfully!`, 'success');
          nameInput.value = '';
          // Force refresh after a short delay
          setTimeout(() => {
            loadCollections();
          }, 500);
        } else {
          showMessage(`✗ Failed to create collection: ${result.error}`, 'error');
        }
      } catch (error) {
        showMessage(`✗ Error creating collection: ${error.message}`, 'error');
      }
    }
    
    function showMessage(text, type) {
      const messageDiv = document.getElementById('createMessage');
      messageDiv.textContent = text;
      messageDiv.className = type === 'success' ? 'message-success' : type === 'error' ? 'message-error' : '';
      messageDiv.style.display = 'block';
      
      // Auto-hide after 3 seconds for success messages
      if (type === 'success') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 3000);
      }
    }
    
    // Load collections on page load
    console.log('Page loaded, calling loadCollections');
    loadCollections();
  </script>

  <div id="footer-placeholder"></div>
</body>
</html>