<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test-n-Save</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333;
            --header-bg: #2c3e50;
            --card-bg: #f8f9fa;
            --border-color: #ddd;
            --shadow: rgba(0,0,0,0.1);
            --input-bg: white;
            --success-bg: #d4edda;
            --success-border: #28a745;
            --error-bg: #f8d7da;
            --error-border: #dc3545;
            --status-bg: #e3f2fd;
        }
        
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --header-bg: #1e1e1e;
            --card-bg: #2d2d2d;
            --border-color: #555;
            --shadow: rgba(0,0,0,0.3);
            --input-bg: #333;
            --success-bg: #1e4d3a;
            --success-border: #28a745;
            --error-bg: #4d1e1e;
            --error-border: #dc3545;
            --status-bg: #1e3a4d;
        }
        
        /* Header and Footer Styles */
        .header {
            background: var(--header-bg);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px var(--shadow);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: gold;
            text-decoration: none;
            text-decoration: none;
        }
        
        .nav-menu {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .nav-menu a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav-menu a:hover {
            background-color: #34495e;
        }
        
        .login-icon {
            background: #3498db;
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--header-bg);
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px var(--shadow);
            z-index: 1;
            border-radius: 4px;
            top: 100%;
            right: 0;
        }
        
        .dropdown-content a {
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            border-radius: 4px;
        }
        
        .dropdown-content a:hover {
            background-color: #34495e;
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 0.5rem;
        }
        
        .hamburger span {
            width: 25px;
            height: 3px;
            background: white;
            margin: 3px 0;
            transition: 0.3s;
        }
        
        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }
            
            .nav-menu {
                position: fixed;
                top: 70px;
                right: -100%;
                width: 100%;
                height: calc(100vh - 70px);
                background: var(--header-bg);
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                transition: right 0.3s;
                padding-top: 2rem;
            }
            
            .nav-menu.active {
                right: 0;
            }
            
            .nav-menu a, .dropdown {
                margin: 1rem 0;
            }
        }
        
        .footer {
            background: var(--header-bg);
            color: white;
            padding: 2rem 0;
            margin-top: 2rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
        }
        
        .footer-links {
            margin-bottom: 1rem;
        }
        
        .footer-links a {
            color: #bdc3c7;
            text-decoration: none;
            margin: 0 1rem;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .copyright {
            font-size: 0.9rem;
            color: #bdc3c7;
        }
        
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .section { margin: 20px 0; border: 1px solid var(--border-color); padding: 15px; border-radius: 5px; background: var(--card-bg); transition: background-color 0.3s; }
        .section-header { font-weight: bold; font-size: 18px; margin-bottom: 10px; }
        .subsection { margin: 10px 0 10px 20px; }
        .subsection-header { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .test-item { margin: 5px 0; padding: 5px; }
        .test-code { font-family: monospace; font-weight: bold; color: #0066cc; }
        .controls { margin: 20px 0; padding: 15px; background: var(--card-bg); border-radius: 5px; transition: background-color 0.3s; }
        .execute-btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .execute-btn:hover { background: #0056b3; }
        .execute-btn:disabled { background: #ccc; cursor: not-allowed; }
        .results { margin: 20px 0; padding: 15px; background: var(--card-bg); border-radius: 5px; min-height: 100px; transition: background-color 0.3s; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="./index.html" class="logo">AISearch-n-Score</a>
            <div class="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <nav class="nav-menu" id="navMenu">
                <a href="./search.html">Search</a>
                <a href="./test.html">Test</a>
                <a href="./index.html#analyze">Analyze</a>
                <div class="dropdown">
                    <a href="#options">Options</a>
                    <div class="dropdown-content">
                        <a href="#dark-mode" onclick="toggleDarkMode()">Toggle Dark Mode</a>
                        <a href="#config">Modify Config Files</a>
                        <a href="#collections">Manage Collections</a>
                        <a href="./update-models.html">Manage Ollama → Add/Update Models</a>
                        <a href="./remove-models.html">Manage Ollama → Remove Models</a>
                    </div>
                </div>
                <div class="login-icon">👤</div>
            </nav>
        </div>
    </header>

    <div style="padding: 20px;">
    <h1>Test-n-Save</h1>
    
    <div class="model-selector" style="margin: 20px 0; padding: 15px; background: var(--card-bg); border-radius: 5px; transition: background-color 0.3s;">
        <div style="font-weight: bold; margin-bottom: 10px;">Models:</div>
        <label><input type="checkbox" id="selectAllModels"> Select All Models</label>
        <div id="modelList" style="margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; background: var(--input-bg);">
            Loading models...
        </div>
    </div>
    
    <div class="token-override" style="margin: 20px 0; padding: 15px; background: var(--card-bg); border-radius: 5px; transition: background-color 0.3s;">
        <div style="font-weight: bold; margin-bottom: 10px;">Token Override:</div>
        <select id="tokenOverride" style="width: 200px; padding: 0.5rem; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color);">
            <option value="">No Override</option>
            <option value="250" selected>250</option>
            <option value="500">500</option>
        </select>
    </div>
    
    <div class="controls">
        <label><input type="checkbox" id="selectAll"> Select All Tests</label>
        <button class="execute-btn" onclick="executeSelectedTests()">Execute Selected Tests</button>
        <span id="selectedCount">0 tests selected</span>
        <div id="executionStatus" style="margin-top: 10px; padding: 10px; background: var(--status-bg); border-radius: 5px; display: none; color: var(--text-color); transition: background-color 0.3s, color 0.3s;">
            <strong>🔄 Test Execution in Progress...</strong>
            <div id="progressIndicator"></div>
        </div>
    </div>

    <div id="testSections"></div>

    <div class="results">
        <h3>Test Results:</h3>
        <div id="testResults">No tests executed yet.</div>
    </div>

    <script>
        const modelTests = {
            "baseline_tests": {
                "title": "Baseline Tests",
                "tests": [
                    {"testcode": "t1111110", "description": "All minimum values, no scoring"},
                    {"testcode": "t3554341", "description": "All maximum values, with scoring"},
                    {"testcode": "t2323230", "description": "Mixed values, no scoring"},
                    {"testcode": "t1452121", "description": "Mixed values, with scoring"},
                    {"testcode": "t1234561", "description": "Sequential progression, with scoring"},
                    {"testcode": "t3521430", "description": "Reverse progression, no scoring"},
                    {"testcode": "t2143120", "description": "Random mix A, no scoring"},
                    {"testcode": "t3415231", "description": "Random mix B, with scoring"}
                ]
            },
            "parameter_specific_tests": {
                "title": "Parameter-Specific Tests",
                "source_type_variations": {
                    "title": "Source Type Variations",
                    "tests": [
                        {"testcode": "t1111110", "description": "Local Model Only baseline"},
                        {"testcode": "t2111110", "description": "Local Documents Only baseline"},
                        {"testcode": "t3111110", "description": "Local Model and Documents baseline"}
                    ]
                },
                "assistant_type_variations": {
                    "title": "Assistant Type Variations",
                    "tests": [
                        {"testcode": "t1111110", "description": "Simple Assistant baseline"},
                        {"testcode": "t1211110", "description": "Detailed Assistant baseline"},
                        {"testcode": "t1311110", "description": "Reasoned Assistant baseline"},
                        {"testcode": "t1411110", "description": "Creative Assistant baseline"},
                        {"testcode": "t1511110", "description": "Coding Assistant baseline"}
                    ]
                },
                "user_prompt_variations": {
                    "title": "User Prompt Variations",
                    "tests": [
                        {"testcode": "t1111110", "description": "KNOWLEDGE-Quantum baseline"},
                        {"testcode": "t1121110", "description": "REASON-AI-adopt baseline"},
                        {"testcode": "t1131110", "description": "CREATE-AI-dialog baseline"},
                        {"testcode": "t1141110", "description": "CODE-Pseudo baseline"},
                        {"testcode": "t1151110", "description": "INSTRUCT-Fix wifi baseline"}
                    ]
                },
                "temperature_variations": {
                    "title": "Temperature Variations",
                    "tests": [
                        {"testcode": "t1111110", "description": "Predictable (0.3) baseline"},
                        {"testcode": "t1111210", "description": "Moderate (0.6) baseline"},
                        {"testcode": "t1111310", "description": "Creative (0.9) baseline"}
                    ]
                },
                "context_variations": {
                    "title": "Context Variations",
                    "tests": [
                        {"testcode": "t1111110", "description": "2048 context baseline"},
                        {"testcode": "t1111120", "description": "4096 context baseline"},
                        {"testcode": "t1111130", "description": "8192 context baseline"},
                        {"testcode": "t1111140", "description": "16384 context baseline"}
                    ]
                },
                "token_limit_variations": {
                    "title": "Token Limit Variations",
                    "tests": [
                        {"testcode": "t1111110", "description": "No Limit baseline"},
                        {"testcode": "t1111120", "description": "250 tokens baseline"},
                        {"testcode": "t1111130", "description": "500 tokens baseline"}
                    ]
                },
                "scoring_variations": {
                    "title": "Scoring Variations",
                    "tests": [
                        {"testcode": "t1111110", "description": "No scoring baseline"},
                        {"testcode": "t1111111", "description": "With scoring baseline"}
                    ]
                }
            },
            "edge_case_tests": {
                "title": "Edge Case Tests",
                "tests": [
                    {"testcode": "t1111431", "description": "Maximum Context + Maximum Tokens + Scoring"},
                    {"testcode": "t1413111", "description": "Creative Assistant + Creative Temperature + Scoring"},
                    {"testcode": "t1544111", "description": "Coding Assistant + CODE-Pseudo + Scoring"},
                    {"testcode": "t3254321", "description": "All Documents + Detailed + AI-adopt + Moderate + 8192 + 250 + Scoring"},
                    {"testcode": "t2135140", "description": "Documents + Simple + CREATE + Creative + 16384 + No Limit + No Scoring"}
                ]
            },
            "compatibility_tests": {
                "title": "Compatibility Tests",
                "tests": [
                    {"testcode": "t1444331", "description": "Creative Assistant + Creative Temperature + Creative Tokens + Scoring"},
                    {"testcode": "t5511111", "description": "Invalid (Assistant Type 5 max) - Error handling test"},
                    {"testcode": "t1611111", "description": "Invalid (User Prompt 6 max) - Error handling test"}
                ]
            }
        };

        function renderTests() {
            const container = document.getElementById('testSections');
            
            // Baseline Tests
            container.appendChild(createSection('baseline', modelTests.baseline_tests));
            
            // Parameter Tests
            const paramSection = document.createElement('div');
            paramSection.className = 'section';
            paramSection.innerHTML = `
                <div class="section-header">
                    <label><input type="checkbox" id="selectParameter"> Parameter-Specific Tests</label>
                </div>
            `;
            
            Object.entries(modelTests.parameter_specific_tests).forEach(([key, value]) => {
                if (key !== 'title' && value.tests) {
                    const subsection = document.createElement('div');
                    subsection.className = 'subsection';
                    subsection.innerHTML = `
                        <div class="subsection-header">
                            <label><input type="checkbox" class="subsection-select" data-group="${key}"> ${value.title}</label>
                        </div>
                    `;
                    value.tests.forEach(test => {
                        subsection.appendChild(createTestItem(test, 'parameter'));
                    });
                    paramSection.appendChild(subsection);
                }
            });
            container.appendChild(paramSection);
            
            // Edge Case Tests
            container.appendChild(createSection('edge', modelTests.edge_case_tests));
            
            // Compatibility Tests
            container.appendChild(createSection('compatibility', modelTests.compatibility_tests));
            
            setupEventListeners();
        }

        function createSection(type, data) {
            const section = document.createElement('div');
            section.className = 'section';
            section.innerHTML = `
                <div class="section-header">
                    <label><input type="checkbox" id="select${type.charAt(0).toUpperCase() + type.slice(1)}"> ${data.title}</label>
                </div>
            `;
            
            data.tests.forEach(test => {
                section.appendChild(createTestItem(test, type));
            });
            
            return section;
        }

        function createTestItem(test, group) {
            const item = document.createElement('div');
            item.className = 'test-item';
            item.innerHTML = `
                <label>
                    <input type="checkbox" class="test-checkbox" data-testcode="${test.testcode}" data-group="${group}">
                    <span class="test-code">${test.testcode}</span> - ${test.description}
                </label>
            `;
            return item;
        }

        function setupEventListeners() {
            // Select All
            document.getElementById('selectAll').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.test-checkbox');
                checkboxes.forEach(cb => cb.checked = this.checked);
                updateSelectedCount();
            });

            // Section selectors
            ['Baseline', 'Edge', 'Compatibility'].forEach(type => {
                const selector = document.getElementById(`select${type}`);
                if (selector) {
                    selector.addEventListener('change', function() {
                        const group = type.toLowerCase();
                        const checkboxes = document.querySelectorAll(`[data-group="${group}"]`);
                        checkboxes.forEach(cb => cb.checked = this.checked);
                        updateSelectedCount();
                    });
                }
            });

            // Parameter section
            document.getElementById('selectParameter').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('[data-group="parameter"]');
                checkboxes.forEach(cb => cb.checked = this.checked);
                updateSelectedCount();
            });

            // Subsection selectors
            document.querySelectorAll('.subsection-select').forEach(selector => {
                selector.addEventListener('change', function() {
                    const group = this.dataset.group;
                    const checkboxes = this.closest('.subsection').querySelectorAll('.test-checkbox');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                    updateSelectedCount();
                });
            });

            // Individual test checkboxes
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('test-checkbox')) {
                    updateSelectedCount();
                }
            });
        }

        function updateSelectedCount() {
            const selected = document.querySelectorAll('.test-checkbox:checked').length;
            document.getElementById('selectedCount').textContent = `${selected} tests selected`;
        }

        async function executeSelectedTests() {
            const selected = Array.from(document.querySelectorAll('.test-checkbox:checked'))
                .map(cb => cb.dataset.testcode);
            
            const selectedModels = Array.from(document.querySelectorAll('.model-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selected.length === 0) {
                alert('Please select at least one test to execute.');
                return;
            }
            
            if (selectedModels.length === 0) {
                alert('Please select at least one model first.');
                return;
            }

            // Show execution status at top
            const statusDiv = document.getElementById('executionStatus');
            const progressDiv = document.getElementById('progressIndicator');
            statusDiv.style.display = 'block';
            progressDiv.innerHTML = `Executing ${selected.length} tests with ${selectedModels.length} model(s)...`;
            
            // Clear bottom results
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            
            // Load configuration data
            const [sourceTypes, systemPrompts, userPrompts, temperatureOptions, contextOptions, tokensOptions] = await Promise.all([
                fetch('./config/source-types.json').then(r => r.json()),
                fetch('./config/system-prompts.json').then(r => r.json()),
                fetch('./config/user-prompts.json').then(r => r.json()),
                fetch('./config/temperature.json').then(r => r.json()),
                fetch('./config/context.json').then(r => r.json()),
                fetch('./config/tokens.json').then(r => r.json())
            ]);
            
            let completedTests = 0;
            const results = [];
            
            for (const testCode of selected) {
                for (const model of selectedModels) {
                    const startTime = Date.now();
                    try {
                        const params = parseTestCode(testCode, sourceTypes, systemPrompts, userPrompts, temperatureOptions, contextOptions, tokensOptions);
                        
                        // Apply token override if selected
                        const tokenOverride = document.getElementById('tokenOverride').value;
                        if (tokenOverride) {
                            params.tokens = parseInt(tokenOverride);
                        }
                        
                        const result = await executeTest(params, model, testCode, params.testCategory, params.testDescription);
                        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
                        results.push({ testCode, model, result, success: true, elapsedTime });
                    } catch (error) {
                        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
                        results.push({ testCode, model, error: error.message, success: false, elapsedTime });
                    }
                    
                    completedTests++;
                    progressDiv.innerHTML = `Completed ${completedTests}/${selected.length * selectedModels.length} tests...`;
                }
            }
            
            // Hide execution status and display results
            statusDiv.style.display = 'none';
            displayTestResults(results);
        }
        
        function parseTestCode(testCode, sourceTypes, systemPrompts, userPrompts, temperatureOptions, contextOptions, tokensOptions) {
            // Parse testcode pattern: t[1-3][1-5][1-5][1-3][1-4][1-3][0-1]
            const sourceTypeMap = ['Local Model Only', 'Local Documents Only', 'Local Model and Documents'];
            const assistantTypeMap = ['Simple Assistant', 'Detailed Assistant', 'Reasoned Assistant', 'Creative Assistant', 'Coding Assistant'];
            const userPromptMap = ['KNOWLEDGE-Quantum', 'REASON-AI-adopt', 'CREATE-AI-dialog', 'CODE-Pseudo', 'INSTRUCT-Fix wifi'];
            const temperatureMap = [0.3, 0.6, 0.9];
            const contextMap = [2048, 4096, 8192, 16384];
            const tokenMap = ['No Limit', '250', '500'];
            
            const sourceType = sourceTypeMap[parseInt(testCode[1]) - 1];
            const assistantType = assistantTypeMap[parseInt(testCode[2]) - 1];
            const userPromptType = userPromptMap[parseInt(testCode[3]) - 1];
            const temperature = temperatureMap[parseInt(testCode[4]) - 1];
            const context = contextMap[parseInt(testCode[5]) - 1];
            const tokens = tokenMap[parseInt(testCode[6]) - 1];
            const generateScores = testCode[7] === '1';
            
            // Determine test category and description
            const { testCategory, testDescription } = getTestCategoryAndDescription(testCode);
            
            // Get system prompt
            const systemPrompt = systemPrompts.system_prompts.find(p => p.name === assistantType);
            
            // Get user prompt
            const userPrompt = userPrompts.user_prompts.find(p => p.name === userPromptType);
            
            return {
                sourceType,
                assistantType,
                systemPrompt: systemPrompt?.prompt || '',
                systemPromptName: assistantType,
                userPrompt: userPrompt?.prompt || 'Default test prompt',
                temperature,
                context,
                tokens: tokens === 'No Limit' ? null : parseInt(tokens),
                generateScores,
                testCategory,
                testDescription
            };
        }
        
        function getTestCategoryAndDescription(testCode) {
            // Define test categories based on the test patterns from AISearchScore-Testcodes.md
            const baselineTests = ['t1111110', 't3554341', 't2323230', 't1452121', 't1234561', 't3521430', 't2143120', 't3415231'];
            const sourceTypeTests = ['t1111110', 't2111110', 't3111110'];
            const assistantTypeTests = ['t1111110', 't1211110', 't1311110', 't1411110', 't1511110'];
            const userPromptTests = ['t1111110', 't1121110', 't1131110', 't1141110', 't1151110'];
            const temperatureTests = ['t1111110', 't1111210', 't1111310'];
            const contextTests = ['t1111110', 't1111120', 't1111130', 't1111140'];
            const tokenTests = ['t1111110', 't1111120', 't1111130'];
            const scoringTests = ['t1111110', 't1111111'];
            const edgeCaseTests = ['t1111431', 't1413111', 't1544111', 't3254321', 't2135140'];
            const compatibilityTests = ['t1444331', 't5511111', 't1611111'];
            
            if (baselineTests.includes(testCode)) {
                return {
                    testCategory: 'Baseline Tests',
                    testDescription: getBaselineDescription(testCode)
                };
            } else if (edgeCaseTests.includes(testCode)) {
                return {
                    testCategory: 'Edge Case Tests',
                    testDescription: getEdgeCaseDescription(testCode)
                };
            } else if (compatibilityTests.includes(testCode)) {
                return {
                    testCategory: 'Compatibility Tests',
                    testDescription: getCompatibilityDescription(testCode)
                };
            } else if (sourceTypeTests.includes(testCode)) {
                return {
                    testCategory: 'Source Type Variations',
                    testDescription: getSourceTypeDescription(testCode)
                };
            } else if (assistantTypeTests.includes(testCode)) {
                return {
                    testCategory: 'Assistant Type Variations',
                    testDescription: getAssistantTypeDescription(testCode)
                };
            } else if (userPromptTests.includes(testCode)) {
                return {
                    testCategory: 'User Prompt Variations',
                    testDescription: getUserPromptDescription(testCode)
                };
            } else if (temperatureTests.includes(testCode)) {
                return {
                    testCategory: 'Temperature Variations',
                    testDescription: getTemperatureDescription(testCode)
                };
            } else if (contextTests.includes(testCode)) {
                return {
                    testCategory: 'Context Variations',
                    testDescription: getContextDescription(testCode)
                };
            } else if (tokenTests.includes(testCode)) {
                return {
                    testCategory: 'Token Limit Variations',
                    testDescription: getTokenDescription(testCode)
                };
            } else if (scoringTests.includes(testCode)) {
                return {
                    testCategory: 'Scoring Variations',
                    testDescription: getScoringDescription(testCode)
                };
            } else {
                return {
                    testCategory: 'Custom Test',
                    testDescription: 'Custom test configuration'
                };
            }
        }
        
        function getBaselineDescription(testCode) {
            const descriptions = {
                't1111110': 'All minimum values, no scoring',
                't3554341': 'All maximum values, with scoring',
                't2323230': 'Mixed values, no scoring',
                't1452121': 'Mixed values, with scoring',
                't1234561': 'Sequential progression, with scoring',
                't3521430': 'Reverse progression, no scoring',
                't2143120': 'Random mix A, no scoring',
                't3415231': 'Random mix B, with scoring'
            };
            return descriptions[testCode] || 'Baseline test';
        }
        
        function getEdgeCaseDescription(testCode) {
            const descriptions = {
                't1111431': 'Maximum Context + Maximum Tokens + Scoring',
                't1413111': 'Creative Assistant + Creative Temperature + Scoring',
                't1544111': 'Coding Assistant + CODE-Pseudo + Scoring',
                't3254321': 'All Documents + Detailed + AI-adopt + Moderate + 8192 + 250 + Scoring',
                't2135140': 'Documents + Simple + CREATE + Creative + 16384 + No Limit + No Scoring'
            };
            return descriptions[testCode] || 'Edge case test';
        }
        
        function getCompatibilityDescription(testCode) {
            const descriptions = {
                't1444331': 'Creative Assistant + Creative Temperature + Creative Tokens + Scoring',
                't5511111': 'Invalid (Assistant Type 5 max) - Error handling test',
                't1611111': 'Invalid (User Prompt 6 max) - Error handling test'
            };
            return descriptions[testCode] || 'Compatibility test';
        }
        
        function getSourceTypeDescription(testCode) {
            const descriptions = {
                't1111110': 'Local Model Only baseline',
                't2111110': 'Local Documents Only baseline',
                't3111110': 'Local Model and Documents baseline'
            };
            return descriptions[testCode] || 'Source type variation';
        }
        
        function getAssistantTypeDescription(testCode) {
            const descriptions = {
                't1111110': 'Simple Assistant baseline',
                't1211110': 'Detailed Assistant baseline',
                't1311110': 'Reasoned Assistant baseline',
                't1411110': 'Creative Assistant baseline',
                't1511110': 'Coding Assistant baseline'
            };
            return descriptions[testCode] || 'Assistant type variation';
        }
        
        function getUserPromptDescription(testCode) {
            const descriptions = {
                't1111110': 'KNOWLEDGE-Quantum baseline',
                't1121110': 'REASON-AI-adopt baseline',
                't1131110': 'CREATE-AI-dialog baseline',
                't1141110': 'CODE-Pseudo baseline',
                't1151110': 'INSTRUCT-Fix wifi baseline'
            };
            return descriptions[testCode] || 'User prompt variation';
        }
        
        function getTemperatureDescription(testCode) {
            const descriptions = {
                't1111110': 'Predictable (0.3) baseline',
                't1111210': 'Moderate (0.6) baseline',
                't1111310': 'Creative (0.9) baseline'
            };
            return descriptions[testCode] || 'Temperature variation';
        }
        
        function getContextDescription(testCode) {
            const descriptions = {
                't1111110': '2048 context baseline',
                't1111120': '4096 context baseline',
                't1111130': '8192 context baseline',
                't1111140': '16384 context baseline'
            };
            return descriptions[testCode] || 'Context variation';
        }
        
        function getTokenDescription(testCode) {
            const descriptions = {
                't1111110': 'No Limit baseline',
                't1111120': '250 tokens baseline',
                't1111130': '500 tokens baseline'
            };
            return descriptions[testCode] || 'Token limit variation';
        }
        
        function getScoringDescription(testCode) {
            const descriptions = {
                't1111110': 'No scoring baseline',
                't1111111': 'With scoring baseline'
            };
            return descriptions[testCode] || 'Scoring variation';
        }
        
        async function executeTest(params, model, testCode, testCategory, testDescription) {
            const response = await fetch('./services/api.js');
            const apiModule = await import('./services/api.js');
            
            const result = await apiModule.search(
                params.userPrompt,
                params.generateScores,
                model,
                params.temperature,
                params.context,
                params.systemPrompt,
                params.systemPromptName,
                params.tokens,
                params.sourceType,
                testCode
            );
            
            // Export to database with category and description
            await exportToDatabase(result, testCategory, testDescription);
            
            return result;
        }
        
        async function exportToDatabase(result, testCategory, testDescription) {
            const dbData = {
                TestCode: result.testCode || '',
                TestCategory: testCategory || null,
                TestDescription: testDescription || null,
                PcCode: result.pcCode || null,
                PcCPU: result.systemInfo?.chip || null,
                PcGraphics: result.systemInfo?.graphics || null,
                PcRAM: result.systemInfo?.ram || null,
                PcOS: result.systemInfo?.os || null,
                CreatedAt: result.createdAt || null,
                SourceType: result.sourceType || null,
                SystemPrompt: result.systemPromptName || null,
                Prompt: result.query || null,
                'ModelName-search': result.metrics?.search?.model || null,
                'ModelContextSize-search': result.metrics?.search?.context_size || null,
                'ModelTemperature-search': result.metrics?.search?.temperature || null,
                'ModelTokenLimit-search': result.tokenLimit || null,
                'Duration-search-s': result.metrics?.search ? (result.metrics.search.total_duration / 1000000000) : null,
                'Load-search-ms': result.metrics?.search ? Math.round(result.metrics.search.load_duration / 1000000) : null,
                'EvalTokensPerSecond-ssearch': result.metrics?.search ? (result.metrics.search.eval_count / (result.metrics.search.eval_duration / 1000000000)) : null,
                'Answer-search': result.response || null,
                'ModelName-score': result.metrics?.scoring?.model || null,
                'ModelContextSize-score': result.metrics?.scoring?.context_size || null,
                'ModelTemperature-score': result.metrics?.scoring?.temperature || null,
                'Duration-score-s': result.metrics?.scoring ? (result.metrics.scoring.total_duration / 1000000000) : null,
                'Load-score-ms': result.metrics?.scoring ? Math.round(result.metrics.scoring.load_duration / 1000000) : null,
                'EvalTokensPerSecond-score': result.metrics?.scoring ? (result.metrics.scoring.eval_count / (result.metrics.scoring.eval_duration / 1000000000)) : null,
                AccurateScore: result.scores?.accuracy || null,
                RelevantScore: result.scores?.relevance || null,
                OrganizedScore: result.scores?.organization || null,
                'WeightedScore-pct': result.scores?.total || null
            };
            
            try {
                const response = await fetch('http://localhost:3001/api/database/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dbData)
                });
                
                const saveResult = await response.json();
                if (!saveResult.success) {
                    console.error('Database save failed:', saveResult.error);
                }
            } catch (error) {
                console.error('Database save error:', error);
            }
        }
        
        function displayTestResults(results) {
            const resultsDiv = document.getElementById('testResults');
            let html = `<h4>Test Execution Complete (${results.length} tests)</h4>`;
            
            results.forEach(({ testCode, model, result, success, error, elapsedTime }) => {
                if (success) {
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid var(--success-border); border-radius: 5px; background: var(--success-bg); color: var(--text-color); transition: background-color 0.3s, color 0.3s;">
                            <strong>${testCode}</strong> (${model}) ${elapsedTime}s - ✅ Success
                            <br><small>Response: ${result.response?.substring(0, 100)}...</small>
                            <br><small>Saved to database</small>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid var(--error-border); border-radius: 5px; background: var(--error-bg); color: var(--text-color); transition: background-color 0.3s, color 0.3s;">
                            <strong>${testCode}</strong> (${model}) ${elapsedTime}s - ❌ Failed
                            <br><small>Error: ${error}</small>
                        </div>
                    `;
                }
            });
            
            // Calculate and display total elapsed time
            const totalElapsedTime = results.reduce((sum, result) => sum + parseFloat(result.elapsedTime), 0);
            const formattedTime = formatTime(totalElapsedTime);
            html += `
                <div style="margin: 20px 0; padding: 15px; border: 2px solid var(--border-color); border-radius: 5px; background: var(--card-bg); color: var(--text-color); text-align: left; font-weight: bold; transition: background-color 0.3s, color 0.3s;">
                    Total Elapsed Time: ${formattedTime}
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        // Load models from Ollama
        async function loadModels() {
            try {
                const response = await fetch('http://localhost:11434/api/tags');
                const data = await response.json();
                const modelList = document.getElementById('modelList');
                modelList.innerHTML = '';
                
                data.models
                    .filter(model => !model.name.includes('nomic-embed-text'))
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(model => {
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        label.style.margin = '5px 0';
                        label.innerHTML = `<input type="checkbox" class="model-checkbox" value="${model.name}"> ${model.name}`;
                        modelList.appendChild(label);
                    });
                
                // Setup select all models functionality
                document.getElementById('selectAllModels').addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.model-checkbox');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                });
                
            } catch (error) {
                console.error('Error loading models:', error);
                document.getElementById('modelList').innerHTML = 'Error loading Ollama models';
            }
        }

        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = (totalSeconds % 60).toFixed(1);
            
            if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }
        
        // Initialize
        loadModels();
        renderTests();
    </script>
    
    <script>
        function toggleDarkMode() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        function toggleMenu() {
            const navMenu = document.getElementById('navMenu');
            navMenu.classList.toggle('active');
        }
    </script>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="#privacy">Privacy Policy</a>
                <a href="#terms">Terms of Service</a>
                <a href="#contact">Contact</a>
            </div>
            <div class="copyright">
                <p>&copy; 2025 AISearch-n-Score Group. All rights reserved.</p>
                <p>Licensed under <a href="http://creativecommons.org/licenses/by-nc/4.0/" style="color: #bdc3c7;">Creative Commons Attribution-NonCommercial (CC BY-NC)</a>.</p>
            </div>
        </div>
    </footer>
</body>
</html>