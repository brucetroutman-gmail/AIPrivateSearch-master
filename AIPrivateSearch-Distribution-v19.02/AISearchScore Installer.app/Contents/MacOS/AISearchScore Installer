#!/bin/bash

# AIPrivateSearch Installer App
# Version 19.02

# Set up logging
LOG_FILE="/tmp/aiprivatesearch-installer.log"
exec 1> >(tee -a "$LOG_FILE")
exec 2>&1

echo "=== AIPrivateSearch Installer Started ==="
echo "Date: $(date)"
echo "User: $(whoami)"

# Function to show dialog
show_dialog() {
    osascript -e "display dialog \"$1\" with title \"AIPrivateSearch Installer\" buttons {\"OK\"} default button \"OK\""
}

# Function to show confirmation dialog
show_confirmation() {
    result=$(osascript -e "display dialog \"$1\" with title \"AIPrivateSearch Installer\" buttons {\"Cancel\", \"Continue\"} default button \"Continue\"" 2>/dev/null)
    if [[ $? -eq 0 ]]; then
        return 0
    else
        return 1
    fi
}

# Welcome message
if ! show_confirmation "Welcome to AIPrivateSearch Installer!

This will install AIPrivateSearch on your Mac with all required dependencies:
• Node.js (if needed)
• Ollama AI platform
• Chrome browser (if needed)
• AIPrivateSearch application

Installation location: /Users/Shared/repos/aiprivatesearch

Continue with installation?"; then
    echo "Installation cancelled by user"
    exit 0
fi

# Download and run the installer
echo "Downloading installer script..."
cd /Users/Shared

# Download the load-aiss.command script
if curl -L -o load-aiss.command "https://raw.githubusercontent.com/drbh/aiprivatesearch/main/load-aiss.command" 2>/dev/null; then
    echo "Downloaded installer script successfully"
    chmod +x load-aiss.command
    
    # Run the installer
    echo "Running AIPrivateSearch installer..."
    ./load-aiss.command
    
    # Check if installation was successful
    if [[ -d "/Users/Shared/repos/aiprivatesearch" ]]; then
        show_dialog "AIPrivateSearch installation completed successfully!

You can now:
• Access the app at: http://localhost:3000
• Find the installation at: /Users/Shared/repos/aiprivatesearch
• Run load-aiss.command anytime to restart

The application should open automatically in your browser."
    else
        show_dialog "Installation may have encountered issues. Please check the Terminal for details or try running load-aiss.command manually from /Users/Shared/"
    fi
else
    show_dialog "Failed to download installer. Please check your internet connection and try again."
    exit 1
fi

echo "=== AIPrivateSearch Installer Finished ==="